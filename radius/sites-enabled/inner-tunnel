server inner-tunnel {

listen {
	type = auth
	proto = udp
  ipaddr = *
  port = 1814
}

authorize {
 preprocess
 rewrite_calling_station_id

  if (!EAP-Message) {
    authorized_macs

    if (!ok) {
      reject
    }
    else {
      update control {
        Auth-Type := Accept
      }
    }
  } else {
    eap
 }
}

authenticate {
eap
}
session {
}

post-auth {
  update control {
    Tmp-String-0 := "%{sql:SELECT vlan from lookup where (common_name = '%{request:TLS-Client-Cert-Common-Name}' AND mac = '%{request:Calling-Station-Id}' AND remote_ip = '%{request:Packet-Src-IP-Address}')}"
  }

  update reply {
    &Tunnel-Type := VLAN
    &Tunnel-Medium-Type := IEEE-802
    &Tunnel-Private-Group-Id := &control:Tmp-String-0
  }
}

pre-proxy {
}
post-proxy {
  eap
}
}