server default {
listen {
        type = auth
        ipaddr = *
        port = 1812
        limit {
              max_connections = 64
              lifetime = 10
              idle_timeout = 30
        }
}

listen {
        ipaddr = *
        port = 0
        type = acct
        limit {
        }
}

authorize {
  preprocess
  rewrite_calling_station_id

  if (!EAP-Message) {
    authorized_macs

    if (!ok) {
      reject
    }
    else {
      update control {
        Auth-Type := Accept
      }
    }
  } else {
    eap
  }
}

authenticate {
  eap
}

post-auth {
  update control {
    Tmp-String-0 := "%{sql:SELECT vlan from lookup where (common_name = '%{request:TLS-Client-Cert-Common-Name}' AND mac = '%{request:Calling-Station-Id}' AND remote_ip = '%{request:Packet-Src-IP-Address}')}"
  }

  update reply {
    &Tunnel-Type := VLAN
    &Tunnel-Medium-Type := IEEE-802
    &Tunnel-Private-Group-Id := &control:Tmp-String-0
  }
}

preacct {
}
accounting {
}
session {
}
pre-proxy {
}
post-proxy {
	eap
}
}